<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.57.2"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sharing light, even in death"><title>在 Linux 上使用 redsocks 进行全局 socks5 - Indexyz Blog</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/spectre.css@0.5.8/dist/spectre.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=https://blog.indexyz.me/css/syntax.css><link rel=stylesheet href=https://blog.indexyz.me/sass/main.min.bfe6bc4bb48fe5e39fc1dcbd6f38413f8c6c9bfcbb5541281b9be860cf0c3d8b.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/disqusjs@1.2/dist/disqusjs.css><script src=https://cdn.jsdelivr.net/npm/disqusjs@1.1/dist/disqus.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-97074604-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-97074604-1');</script></head><body><header id=page-header><div class="container grid-lg"><a href=https://blog.indexyz.me/ class=title>Indexyz Blog</a><h2 class=description>Sharing light, even in death</h2><div><nav id=nav-menu role=navigation><a href=/>首页</a>
<a href=/friends/>友链</a></nav></div></div></header><main><div class="container grid-lg"><section id=posts class=post-single><article temscope itemtype=http://schema.org/Article><header><h1 class=post-title itemprop="name headline"><a href=https://blog.indexyz.me/archives/use-redsocks-proxy-global-via-redsocks/ itemprop=url>在 Linux 上使用 redsocks 进行全局 socks5</a></h1><div class=post-meta-list><span class=post-meta><span>时间:</span>
<time datetime=2017-10-22T15:40:15Z>2017-10-22</time></span>
<span class=post-meta><span>分类:</span>
<a href=/categories/linux itemprop=url rel=index><span itemprop=name>Linux</span></a>
&nbsp;</span></span></div></header><div class=post-body itemprop=articleBody><p>在中国大陆由于一些众所周知以及网络环境有时候会比较差的原因, 我们可能会需要使用代理服务器来进行转发流量. 但是有些软件不支持代理, 如何让它走代理呢? 那就要介绍下 <code>redsocks</code> 了.</p><h1 id=安装>安装</h1><p>redsocks 的安装比较方便 从 GitHub 检出代码然后编译就好了</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>git clone https://github.com/darkk/redsocks
<span class=ln>2</span><span class=nb>cd</span> redsocks
<span class=ln>3</span>make</code></pre></div><h2 id=配置>配置</h2><p>默认我们认为本地 <code>socks</code> 代理在 <code>127.0.0.1:1080</code>
将配置文件配为下面这样</p><div class=highlight><pre class=chroma><code class=language-conf data-lang=conf><span class=ln> 1</span>// $ cat redsocks.conf
<span class=ln> 2</span>base {
<span class=ln> 3</span>    log_debug = off;
<span class=ln> 4</span>    log_info = off;
<span class=ln> 5</span>    log = &#34;syslog:daemon&#34;;
<span class=ln> 6</span>    // 改成 on 使用 daemon 运行
<span class=ln> 7</span>    daemon = on;
<span class=ln> 8</span>    user = redsocks;
<span class=ln> 9</span>    group = redsocks;
<span class=ln>10</span>    redirector = iptables;
<span class=ln>11</span>}
<span class=ln>12</span>
<span class=ln>13</span>redsocks {
<span class=ln>14</span>    local_ip = 127.0.0.1;
<span class=ln>15</span>    local_port = 31338;
<span class=ln>16</span>
<span class=ln>17</span>    ip = 127.0.0.1;
<span class=ln>18</span>    port = 1080;
<span class=ln>19</span>
<span class=ln>20</span>    type = socks5;
<span class=ln>21</span>}</code></pre></div><h2 id=启动>启动</h2><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>./redsocks</code></pre></div><p>就可以运行了</p><h1 id=配置-iptables>配置 iptables</h1><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln> 1</span><span class=c1># Transparent SOCKS proxy</span>
<span class=ln> 2</span><span class=c1># See: http://darkk.net.ru/redsocks/</span>
<span class=ln> 3</span>
<span class=ln> 4</span>*nat
<span class=ln> 5</span>:PREROUTING ACCEPT <span class=o>[</span><span class=m>0</span>:0<span class=o>]</span>
<span class=ln> 6</span>:INPUT ACCEPT <span class=o>[</span><span class=m>0</span>:0<span class=o>]</span>
<span class=ln> 7</span>:OUTPUT ACCEPT <span class=o>[</span><span class=m>0</span>:0<span class=o>]</span>
<span class=ln> 8</span>:POSTROUTING ACCEPT <span class=o>[</span><span class=m>0</span>:0<span class=o>]</span>
<span class=ln> 9</span>:REDSOCKS - <span class=o>[</span><span class=m>0</span>:0<span class=o>]</span>
<span class=ln>10</span>
<span class=ln>11</span><span class=c1># Redirect all output through redsocks</span>
<span class=ln>12</span>-A OUTPUT -p tcp -j REDSOCKS
<span class=ln>13</span>
<span class=ln>14</span><span class=c1># Whitelist LANs and some other reserved addresses.</span>
<span class=ln>15</span><span class=c1># https://en.wikipedia.org/wiki/Reserved_IP_addresses#Reserved_IPv4_addresses</span>
<span class=ln>16</span>-A REDSOCKS -d <span class=m>0</span>.0.0.0/8 -j RETURN
<span class=ln>17</span>-A REDSOCKS -d <span class=m>10</span>.0.0.0/8 -j RETURN
<span class=ln>18</span>-A REDSOCKS -d <span class=m>127</span>.0.0.0/8 -j RETURN
<span class=ln>19</span>-A REDSOCKS -d <span class=m>169</span>.254.0.0/16 -j RETURN
<span class=ln>20</span>-A REDSOCKS -d <span class=m>172</span>.16.0.0/12 -j RETURN
<span class=ln>21</span>-A REDSOCKS -d <span class=m>192</span>.168.0.0/16 -j RETURN
<span class=ln>22</span>-A REDSOCKS -d <span class=m>224</span>.0.0.0/4 -j RETURN
<span class=ln>23</span>-A REDSOCKS -d <span class=m>240</span>.0.0.0/4 -j RETURN
<span class=ln>24</span><span class=c1>#-A REDSOCKS -d { 代理服务端的地址 } -j RETURN</span>
<span class=ln>25</span><span class=c1># shadowsocks server port</span>
<span class=ln>26</span>-A REDSOCKS -p tcp --dport <span class=o>{</span> 代理服务端的端口 <span class=o>}</span> -j RETURN
<span class=ln>27</span>
<span class=ln>28</span><span class=c1># Redirect everything else to redsocks port</span>
<span class=ln>29</span>-A REDSOCKS -p tcp -j REDIRECT --to-ports <span class=m>31338</span>
<span class=ln>30</span>
<span class=ln>31</span>COMMIT</code></pre></div><p>然后全部的 <code>TCP</code> 链接就会走代理了</p></div></article><ul class=pagination><li class="page-item page-prev"><a href=https://blog.indexyz.me/archives/grafana-collectd-collectd-monitor/><div class=page-item-subtitle>上一篇</div><div class="page-item-title h5">Linux 搭建 grafana &#43; influxdb &#43; collectd</div></a></li><li class="page-item page-next"><a href=https://blog.indexyz.me/archives/use-asf2-to-farm-in-linux/><div class=page-item-subtitle>下一篇</div><div class="page-item-title h5">在Linux系统上使用ASF挂卡</div></a></li></ul><div id=disqus_thread></div><script>new DisqusJS(JSON.parse("{\"api\":\"https://disqus.skk.moe/disqus/\",\"apikey\":\"VtpQwhbhO3YTIYSZdx1N8vOJ6me3une1xSIeXhpuPcE4jurE17UlJozkc9qhvjDw\",\"shortname\":\"indexyz-blog\",\"sitename\":\"Indexyz Blog\"}"))</script></section></div></main><footer class=page-footer><p>Copyright © 2018-2020, Indexyz</p><p>Power by
<a href=https://gohugo.io/>Hugo</a> | Theme
<a href=https://github.com/Indexyz/hugo-theme-index/>Index</a></p></footer></body></html>