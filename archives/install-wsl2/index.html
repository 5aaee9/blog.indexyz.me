<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.57.2"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sharing light, even in death"><title>WSL2 踩坑日记 - Indexyz Blog</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/spectre.css@0.5.8/dist/spectre.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=https://blog.indexyz.me/css/syntax.css><link rel=stylesheet href=https://blog.indexyz.me/sass/main.min.bfe6bc4bb48fe5e39fc1dcbd6f38413f8c6c9bfcbb5541281b9be860cf0c3d8b.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/disqusjs@1.2/dist/disqusjs.css><script src=https://cdn.jsdelivr.net/npm/disqusjs@1.1/dist/disqus.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-97074604-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-97074604-1');</script></head><body><header id=page-header><div class="container grid-lg"><a href=https://blog.indexyz.me/ class=title>Indexyz Blog</a><h2 class=description>Sharing light, even in death</h2><div><nav id=nav-menu role=navigation><a href=/>首页</a>
<a href=/friends/>友链</a></nav></div></div></header><main><div class="container grid-lg"><section id=posts class=post-single><article temscope itemtype=http://schema.org/Article><header><h1 class=post-title itemprop="name headline"><a href=https://blog.indexyz.me/archives/install-wsl2/ itemprop=url>WSL2 踩坑日记</a></h1><div class=post-meta-list><span class=post-meta><span>时间:</span>
<time datetime=2020-07-12T02:51:08&#43;0800>2020-07-12</time></span>
<span class=post-meta><span>分类:</span>
<a href=/categories/windows itemprop=url rel=index><span itemprop=name>Windows</span></a>
&nbsp;</span></span></div></header><div class=post-body itemprop=articleBody><p>618 搞了个 NUC10 做上网机用, 想了一下还是装 Windows 好了. 然后就装了 2004, 直接在 WSL2 中运行一些东西.</p><h2 id=安装-wsl2>安装 WSL2</h2><h3 id=安装-linux-kernel>安装 Linux Kernel</h3><p>你需要下载 Linux Kernel 并安装, 可以从 <a href=https://aka.ms/wsl2kernel>微软官方的 WSL2 Kernel 地址</a> 下载到. 然后我们就得到了 <code>wsl_update_x64.msi</code> <del>这一步真的是非常的 Windows</del></p><h3 id=设定-wsl-为-nolsp>设定 WSL 为 NoLSP</h3><p>我 Windows 中使用了 Proxifier 把流量引导到 Clash 进行全局策略代理, 但是 WSL 这玩意在用 Proxifier 的情况下会有问题, 在运行 WSL 的时候会提示 <code>The attempted operation is not supported for the type of object referenced.</code></p><p>参考 <a href=https://github.com/microsoft/WSL/issues/4177#issuecomment-597736482>microsoft/WSL#4177 (comment)</a></p><blockquote><p>The easiest solution is to use WSCSetApplicationCategory WinAPI call for wsl.exe to prevent this. Under the hood the call creates an entry for wsl.exe at <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\WinSock2\Parameters\AppId_Catalog</code> This tells Windows not to load LSP DLLs into wsl.exe process.</p></blockquote><p>同时 Proxifier 释出了一个 <a href=https://www.proxifier.com/tmp/Test20200228/NoLsp.exe>工具</a>, 可以帮助设定 NoLSP 的设定</p><p>创建一个新的管理员 Powershell, 进入 NoLSP 所在的位置</p><div class=highlight><pre class=chroma><code class=language-powershell data-lang=powershell><span class=ln>1</span><span class=p>./</span><span class=n>NoLsp</span><span class=p>.</span><span class=n>exe</span> <span class=n>c</span><span class=err>:</span><span class=p>\</span><span class=n>windows</span><span class=p>\</span><span class=n>system32</span><span class=p>\</span><span class=n>wsl</span><span class=p>.</span><span class=n>exe</span></code></pre></div><p>然后再次运行 WSL 就可以正常运行了</p><h3 id=安装-archwsl>安装 ArchWSL</h3><p>作为一个 Arch 粉, WSL 当然要用 <del>Ubuntu</del> Arch 啦, 最新的 ArchWSL 已经支持了 WSL2, 所以我们只需要进入 <a href=https://github.com/yuk7/ArchWSL/releases>ArchWSL Release</a> 下载最新的 <code>ArchWSL.appx</code> 进行安装就好了</p><p>在安装前我们需要安装 cer 文件, 选择安装到 Local Machine 的 <code>Trusted Root Certification Authorities</code> 中, 在安装完成之后就可以去删除掉这个证书.</p><p><img src=https://i.loli.net/2020/06/22/P4oT5MckQJi1AnL.png alt=安装证书></p><p>然后在 Windows Terminal 中就可以看到 Arch 的 Profile 了</p><p><img src=https://i.loli.net/2020/06/22/AO8IfsVHkq9GK2X.png alt="查看 Profile"></p><p>或者我们可以通过 <code>arch</code> 命令进入 arch 的 shell 中去</p><p><img src=https://i.loli.net/2020/06/22/DyT1XIEtimBdHoh.png alt=成果></p><h2 id=配置>配置</h2><h3 id=dns-server-有问题>DNS Server 有问题</h3><p>WSL 默认的 DNS 服务器是宿主机, 并且每次运行会覆盖 <code>/etc/resolv.conf</code>, 这个在某些情况下会有些问题.</p><p>在 <code>/etc/wsl.conf</code> 中取消 ResolvConf 的生成</p><pre><code>cat &gt; /etc/wsl.conf &lt;&lt;EOF
[network]
generateResolvConf = false
EOF
</code></pre><p>然后打开一个新的 Powershell 窗口执行</p><div class=highlight><pre class=chroma><code class=language-powershell data-lang=powershell><span class=ln>1</span><span class=n>wsl</span> <span class=p>-</span><span class=n>-shutdown</span></code></pre></div><p>然后在 <code>/etc/resolv.conf</code> 中添加需要的 nameserver 就好了</p><h3 id=在-arch-内的-docker-不正常>在 Arch 内的 Docker 不正常</h3><p>如果直接通过 pacman 安装 docker 并且通过 <code>dockerd</code> 运行, 在运行容器的时候会提示</p><pre><code>docker: Error response from daemon: cgroups: cannot find cgroup mount destination: unknown.
</code></pre><p>这个问题出现的原因是因为因为 WSL 的实现原因, 整个系统并不是以 systemd 作为 init 的, 所以 docker 在运行的时候找不到 cgroup 相关文件系统.</p><p>可以在 shell 中运行 <a href=https://github.com/microsoft/WSL/issues/4189>cgroup 的 workaround</a> 来创建 cgroup 分区</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>mkdir /sys/fs/cgroup/systemd
<span class=ln>2</span>mount -t cgroup -o none,name<span class=o>=</span>systemd cgroup /sys/fs/cgroup/systemd</code></pre></div></div></article><ul class=pagination><li class="page-item page-next"><a href=https://blog.indexyz.me/archives/install-linux-in-xiaoxin/><div class=page-item-subtitle>下一篇</div><div class="page-item-title h5">在小新 13 Pro 上安装 Linux Desktop 环境</div></a></li></ul><div id=disqus_thread></div><script>new DisqusJS(JSON.parse("{\"api\":\"https://disqus.skk.moe/disqus/\",\"apikey\":\"VtpQwhbhO3YTIYSZdx1N8vOJ6me3une1xSIeXhpuPcE4jurE17UlJozkc9qhvjDw\",\"shortname\":\"indexyz-blog\",\"sitename\":\"Indexyz Blog\"}"))</script></section></div></main><footer class=page-footer><p>Copyright © 2018-2020, Indexyz</p><p>Power by
<a href=https://gohugo.io/>Hugo</a> | Theme
<a href=https://github.com/Indexyz/hugo-theme-index/>Index</a></p></footer></body></html>