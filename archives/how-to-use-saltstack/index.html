<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.57.2"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sharing light, even in death"><title>使用 SaltStack 进行集群管理 - Indexyz Blog</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/spectre.css@0.5.8/dist/spectre.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=https://blog.indexyz.me/css/syntax.css><link rel=stylesheet href=https://blog.indexyz.me/sass/main.min.bfe6bc4bb48fe5e39fc1dcbd6f38413f8c6c9bfcbb5541281b9be860cf0c3d8b.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/disqusjs@1.2/dist/disqusjs.css><script src=https://cdn.jsdelivr.net/npm/disqusjs@1.1/dist/disqus.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-97074604-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-97074604-1');</script></head><body><header id=page-header><div class="container grid-lg"><a href=https://blog.indexyz.me/ class=title>Indexyz Blog</a><h2 class=description>Sharing light, even in death</h2><div><nav id=nav-menu role=navigation><a href=/>首页</a>
<a href=/friends/>友链</a></nav></div></div></header><main><div class="container grid-lg"><section id=posts class=post-single><article temscope itemtype=http://schema.org/Article><header><h1 class=post-title itemprop="name headline"><a href=https://blog.indexyz.me/archives/how-to-use-saltstack/ itemprop=url>使用 SaltStack 进行集群管理</a></h1><div class=post-meta-list><span class=post-meta><span>时间:</span>
<time datetime=2017-08-09T18:33:14Z>2017-08-09</time></span>
<span class=post-meta><span>分类:</span>
<a href=/categories/linux itemprop=url rel=index><span itemprop=name>Linux</span></a>
&nbsp;</span></span></div></header><div class=post-body itemprop=articleBody><p>Saltstack 是一个使用 Python 编写的开源项目 扩展性很好 可以方便快速的管理大量服务器 它使用了 ZeroMQ 消息队列实现服务端之间的秒级通讯</p><blockquote><p>实在是厌倦了对大量服务器日复一日的重复操作。尤其是在虚拟化的时代，系统的每个组件都有很多个相同的节点在运行，更让重复的次数再乘以N。 当我发现Salt的时候，我的眼前一亮：这正是我所需要的东西。</p></blockquote><h2 id=始>始</h2><p>我现在在使用 Saltstack (以下简称salt) 进行我的服务管理 因为我的有些服务并不能 Docker 化而是要统一部署和管理 (比如各个Rancher的Node管理什么的)</p><h3 id=概念>概念</h3><p>salt 在部署上可分为 <code>master</code> 和 <code>minion</code> master 负责下发指令和配置文件之类的消息 minion 负责执行命令并返回消息</p><p>salt 提供了文件配置和命令行管理两种主机管理方式</p><p>salt 在配置文件的储存方式上使用了便于读写的 <a href=https://zh.wikipedia.org/wiki/YAML><code>YAML</code></a> YAML 主要使用了空格和缩进来表达语义 上手也挺快的 看完 Wikipedia 上的介绍就基本上可以使用 YAML 了</p><h4 id=grains>Grains</h4><p><code>grains</code> 相当于各个节点独立的配置文件</p><p>储存在每个节点的 <code>/etc/salt/grains</code> 当中 使用 <code>YAML</code> 格式储存</p><h4 id=salt-文件系统>Salt 文件系统</h4><p>Salt 中的文件以 <code>salt://</code> 开头 指 saltstack 主目录(默认为<code>/srv/salt</code> 可在 master 的设定中更改)的相对路径</p><h3 id=安装>安装</h3><h4 id=salt-bootstrap>Salt Bootstrap</h4><p>salt官方有提供一个通用的
<a href=https://docs.saltstack.com/en/latest/topics/tutorials/salt_bootstrap.html>安装脚本</a>
通常来说 我们只需要</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>curl -L http://bootstrap.saltstack.org <span class=p>|</span> sudo sh -s -- -M -N  <span class=c1># 仅安装Master</span>
<span class=ln>2</span>wget -O - http://bootstrap.saltstack.org <span class=p>|</span> sudo sh            <span class=c1># 安装 Minion</span></code></pre></div><h4 id=包管理安装>包管理安装</h4><p>salt 在各个 Linux 发行版的软件包管理器中应该都提供了现成的软件包</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>apt-get install salt-master         <span class=c1># Ubuntu</span>
<span class=ln>2</span>yum install salt-master             <span class=c1># Centos, require epel</span></code></pre></div><h4 id=修改配置文件>修改配置文件</h4><p>在 minion 端执行</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>sed -i <span class=s1>&#39;s/#master: salt/master: Master主控IP/g&#39;</span> /etc/salt/minion
<span class=ln>2</span>systemctl restart salt-minion</code></pre></div><h4 id=接受key>接受Key</h4><p>salt 使用AES加密消息来保障信息传输的安全性 因此 master 首先应该接受 minion 的密匙才能完成配对</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt-key -L</code></pre></div><p>你应该可以看到如下提示消息</p><pre><code>Accepted Keys:
Denied Keys:
Unaccepted Keys:
salt-minion-1
Rejected Keys:
</code></pre><p>使用 以下指令接受 <code>salt-minion-1</code> 的密匙</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt-key -a salt-minion-1</code></pre></div><p>当然 你也可以 用以下指令接受全部的密匙</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt-key -A</code></pre></div><h2 id=开始使用>开始使用</h2><h3 id=下发指令>下发指令</h3><h4 id=常用指令>常用指令</h4><h5 id=测试所有节点的连通性>测试所有节点的连通性</h5><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt <span class=s1>&#39;*&#39;</span> test.ping</code></pre></div><h5 id=删除已离线的-minion>删除已离线的 minion</h5><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt-run manage.down <span class=nv>removekeys</span><span class=o>=</span>True</code></pre></div><h5 id=测试网络连通性>测试网络连通性</h5><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt <span class=s1>&#39;*&#39;</span> cmd.run <span class=s1>&#39;ping google.com -c 4&#39;</span></code></pre></div><h4 id=minion选择器>Minion选择器</h4><p>在上面的几个常用的指令中 使用了 <code>salt '*'</code> 来选择所有节点 那么 还有没有别的选择方式么 那当然是有的</p><h5 id=根据节点id选择>根据节点ID选择</h5><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt <span class=s1>&#39;salt-minion-1&#39;</span> test.ping</code></pre></div><h5 id=根据-grains-是否存在选择>根据 grains 是否存在选择</h5><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt -G <span class=s1>&#39;flag:1&#39;</span> test.ping           <span class=c1># Flag 是一个为 1 的 grains属性</span></code></pre></div><p>因为 grains 预处理了一些变量 所以我们可以</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt -G <span class=s1>&#39;os:CentOS&#39;</span> test.ping        <span class=c1># 在所有 CentOS 系统的 minion 上执行</span></code></pre></div><h4 id=常用execution>常用Execution</h4><p>官方其实有个
<a href=https://docs.saltstack.com/en/latest/ref/modules/all/index.html>Execution的列表</a>
在这也讲一下常用的几个常用Execution好了</p><h5 id=运行命令>运行命令</h5><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt <span class=s1>&#39;*&#39;</span> cmd.run <span class=s1>&#39;{command}&#39;</span>        <span class=c1># 替换 Command 为你的命令</span></code></pre></div><h5 id=服务操作>服务操作</h5><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt <span class=s1>&#39;*&#39;</span> service.status <span class=o>{</span>service<span class=o>}</span>   <span class=c1># 查看服务状态</span>
<span class=ln>2</span>salt <span class=s1>&#39;*&#39;</span> service.restart <span class=o>{</span>service<span class=o>}</span>  <span class=c1># 重启服务</span>
<span class=ln>3</span>salt <span class=s1>&#39;*&#39;</span> service.start <span class=o>{</span>service<span class=o>}</span>    <span class=c1># 启动服务</span>
<span class=ln>4</span>salt <span class=s1>&#39;*&#39;</span> service.stop <span class=o>{</span>service<span class=o>}</span>     <span class=c1># 停止服务</span></code></pre></div><h5 id=文件分发>文件分发</h5><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt <span class=s1>&#39;*&#39;</span> cp.get_file salt://<span class=o>{</span>file<span class=o>}</span> /to/path/<span class=o>{</span>file<span class=o>}</span></code></pre></div><p>追加到文件尾</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=ln>1</span>salt <span class=s1>&#39;*&#39;</span> file.append /to/file <span class=s2>&#34;{data}&#34;</span></code></pre></div></div></article><ul class=pagination><li class="page-item page-prev"><a href=https://blog.indexyz.me/archives/authlib-usage/><div class=page-item-subtitle>上一篇</div><div class="page-item-title h5">Authlib 使用教程</div></a></li><li class="page-item page-next"><a href=https://blog.indexyz.me/archives/how-to-run-left-4-dead-2-server-in-linux/><div class=page-item-subtitle>下一篇</div><div class="page-item-title h5">在Linux上安装并且运行求生之路2服务器</div></a></li></ul><div id=disqus_thread></div><script>new DisqusJS(JSON.parse("{\"api\":\"https://disqus.skk.moe/disqus/\",\"apikey\":\"VtpQwhbhO3YTIYSZdx1N8vOJ6me3une1xSIeXhpuPcE4jurE17UlJozkc9qhvjDw\",\"shortname\":\"indexyz-blog\",\"sitename\":\"Indexyz Blog\"}"))</script></section></div></main><footer class=page-footer><p>Copyright © 2018-2020, Indexyz</p><p>Power by
<a href=https://gohugo.io/>Hugo</a> | Theme
<a href=https://github.com/Indexyz/hugo-theme-index/>Index</a></p></footer></body></html>