<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.57.2"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sharing light, even in death"><title>自动更新 Rancher 上的应用 - Indexyz Blog</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/spectre.css@0.5.8/dist/spectre.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=https://blog.indexyz.me/css/syntax.css><link rel=stylesheet href=https://blog.indexyz.me/sass/main.min.bfe6bc4bb48fe5e39fc1dcbd6f38413f8c6c9bfcbb5541281b9be860cf0c3d8b.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/disqusjs@1.2/dist/disqusjs.css><script src=https://cdn.jsdelivr.net/npm/disqusjs@1.1/dist/disqus.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-97074604-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-97074604-1');</script></head><body><header id=page-header><div class="container grid-lg"><a href=https://blog.indexyz.me/ class=title>Indexyz Blog</a><h2 class=description>Sharing light, even in death</h2><div><nav id=nav-menu role=navigation><a href=/>首页</a>
<a href=/friends/>友链</a></nav></div></div></header><main><div class="container grid-lg"><section id=posts class=post-single><article temscope itemtype=http://schema.org/Article><header><h1 class=post-title itemprop="name headline"><a href=https://blog.indexyz.me/archives/automatic-deploy-rancher/ itemprop=url>自动更新 Rancher 上的应用</a></h1><div class=post-meta-list><span class=post-meta><span>时间:</span>
<time datetime=2018-02-03T23:49:00Z>2018-02-03</time></span>
<span class=post-meta><span>分类:</span>
<a href=/categories/software itemprop=url rel=index><span itemprop=name>Software</span></a>
&nbsp;</span></span></div></header><div class=post-body itemprop=articleBody><p>之前有介绍过 <code>rancher</code> 的使用方式 现在有个新的问题 如果我们需要在每次 <code>CI</code> 构建结束之后都自动更新 rancher 上的 service 该怎么办</p><p>Rancher 官方有提供一个 <a href=https://rancher.com/docs/rancher/v1.6/en/api/v2-beta/>API</a> 通过他我们可以方便的管理 rancher 的各个功能</p><p>当然 我也写了一个小工具来更新 service</p><p>{% github Indexyz rancher-webhook-update %}</p><h2 id=如何使用>如何使用</h2><p>现在我就适配了在 <code>gitlab</code> 的 CI 构建完成之后来更新 service</p><p>为什么选择 gitlab ?</p><p>原因有两个
1. GitLab 提供免费的 Registry 可以在每次构建成功之后直接从他的 Registery 中拉下映像
2. GitLab 支持免费私有 Repo</p><p><del>简单来说就是我穷</del></p><h3 id=安装>安装</h3><p>修改 <code>config.py</code> 中的内容为你的配置文件</p><p>当然这些配置项都是可以通过环境变量来设置的</p><p>这样可以方便我们直接在 <code>Docker</code> 中跑起来项目 或者是在 <code>Heroku</code> 上托管</p><h3 id=运行>运行</h3><p>直接 <code>gunicorn main:app --log-file=-</code> 然后就运行了一个在 <code>:8080</code> 上的服务器</p><h3 id=配置>配置</h3><p>在 <code>GitLab</code> 的 <code>Settings &gt; Integrations</code> 添加 <code>Webhook</code></p><p><img src=https://publish.indexyz.me/images/2018/02/04/gitlab-integations.png alt="gitlab integations"></p><blockquote><p>通过 <a href=https://www.random.org>random.org</a> 来生成高强度的 <code>Secret Token</code></p></blockquote><p>我们在下面的多选框中选中 <code>Pipeline events</code> 并且输入我们的 updater 的地址</p><p>地址 的格式为</p><pre><code>http(s)://url-of-updater/webhook/gitlab/{prject-id}/{service-id}
</code></pre><p>然后 在每次构建成功的时候就会自带推送了!</p></div></article><ul class=pagination><li class="page-item page-prev"><a href=https://blog.indexyz.me/archives/install-centos-via-network/><div class=page-item-subtitle>上一篇</div><div class="page-item-title h5">网络重装 CentOS</div></a></li><li class="page-item page-next"><a href=https://blog.indexyz.me/archives/setup-sspanel-via-docker/><div class=page-item-subtitle>下一篇</div><div class="page-item-title h5">使用 Docker 快速安装 ss-panel-v3-mod</div></a></li></ul><div id=disqus_thread></div><script>new DisqusJS(JSON.parse("{\"api\":\"https://disqus.skk.moe/disqus/\",\"apikey\":\"VtpQwhbhO3YTIYSZdx1N8vOJ6me3une1xSIeXhpuPcE4jurE17UlJozkc9qhvjDw\",\"shortname\":\"indexyz-blog\",\"sitename\":\"Indexyz Blog\"}"))</script></section></div></main><footer class=page-footer><p>Copyright © 2018-2020, Indexyz</p><p>Power by
<a href=https://gohugo.io/>Hugo</a> | Theme
<a href=https://github.com/Indexyz/hugo-theme-index/>Index</a></p></footer></body></html>