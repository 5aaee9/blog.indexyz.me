<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.57.2"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sharing light, even in death"><title>使 Go App 使用 DNS over TLS - Indexyz Blog</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/spectre.css@0.5.8/dist/spectre.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=https://blog.indexyz.me/css/syntax.css><link rel=stylesheet href=https://blog.indexyz.me/sass/main.min.bfe6bc4bb48fe5e39fc1dcbd6f38413f8c6c9bfcbb5541281b9be860cf0c3d8b.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/disqusjs@1.2/dist/disqusjs.css><script src=https://cdn.jsdelivr.net/npm/disqusjs@1.1/dist/disqus.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-97074604-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-97074604-1');</script></head><body><header id=page-header><div class="container grid-lg"><a href=https://blog.indexyz.me/ class=title>Indexyz Blog</a><h2 class=description>Sharing light, even in death</h2><div><nav id=nav-menu role=navigation><a href=/>首页</a>
<a href=/friends/>友链</a></nav></div></div></header><main><div class="container grid-lg"><section id=posts class=post-single><article temscope itemtype=http://schema.org/Article><header><h1 class=post-title itemprop="name headline"><a href=https://blog.indexyz.me/archives/use-dns-over-tls-in-golang/ itemprop=url>使 Go App 使用 DNS over TLS</a></h1><div class=post-meta-list><span class=post-meta><span>时间:</span>
<time datetime=2018-12-06T16:45:00&#43;0800>2018-12-06</time></span>
<span class=post-meta><span>分类:</span>
<a href=/categories/golang itemprop=url rel=index><span itemprop=name>Golang</span></a>
&nbsp;</span></span></div></header><div class=post-body itemprop=articleBody><p>最近使用 Golang 写了一个应用, 但是在使用的时候发现有些域名在中国被污染了. 于是使用 <code>DoT (DNS over TLS)</code> 解决了这个问题</p><h2 id=具体实现>具体实现</h2><div class=highlight><pre class=chroma><code class=language-go data-lang=go><span class=ln> 1</span><span class=kd>func</span> <span class=nf>newResolver</span><span class=p>(</span><span class=nx>serverName</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>addr</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>net</span><span class=p>.</span><span class=nx>Resolver</span> <span class=p>{</span>
<span class=ln> 2</span>	<span class=kd>var</span> <span class=nx>dialer</span> <span class=nx>net</span><span class=p>.</span><span class=nx>Dialer</span>
<span class=ln> 3</span>	<span class=nx>tlsConfig</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>tls</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
<span class=ln> 4</span>		<span class=nx>ServerName</span><span class=p>:</span> <span class=nx>serverName</span><span class=p>,</span>
<span class=ln> 5</span>		<span class=nx>ClientSessionCache</span><span class=p>:</span> <span class=nx>tls</span><span class=p>.</span><span class=nf>NewLRUClientSessionCache</span><span class=p>(</span><span class=mi>32</span><span class=p>),</span>
<span class=ln> 6</span>
<span class=ln> 7</span>		<span class=nx>InsecureSkipVerify</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
<span class=ln> 8</span>	<span class=p>}</span>
<span class=ln> 9</span>
<span class=ln>10</span>	<span class=k>return</span> <span class=o>&amp;</span><span class=nx>net</span><span class=p>.</span><span class=nx>Resolver</span><span class=p>{</span>
<span class=ln>11</span>		<span class=nx>PreferGo</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
<span class=ln>12</span>		<span class=nx>Dial</span><span class=p>:</span> <span class=kd>func</span> <span class=p>(</span><span class=nx>context</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>address</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=nx>net</span><span class=p>.</span><span class=nx>Conn</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
<span class=ln>13</span>			<span class=nx>conn</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>dialer</span><span class=p>.</span><span class=nf>DialContext</span><span class=p>(</span><span class=nx>context</span><span class=p>,</span> <span class=s>&#34;tcp&#34;</span><span class=p>,</span> <span class=nx>addr</span><span class=p>)</span>
<span class=ln>14</span>			<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
<span class=ln>15</span>				<span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>err</span>
<span class=ln>16</span>			<span class=p>}</span>
<span class=ln>17</span>
<span class=ln>18</span>			<span class=nx>_</span> <span class=p>=</span> <span class=nx>conn</span><span class=p>.(</span><span class=o>*</span><span class=nx>net</span><span class=p>.</span><span class=nx>TCPConn</span><span class=p>).</span><span class=nf>SetKeepAlive</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
<span class=ln>19</span>			<span class=nx>_</span> <span class=p>=</span> <span class=nx>conn</span><span class=p>.(</span><span class=o>*</span><span class=nx>net</span><span class=p>.</span><span class=nx>TCPConn</span><span class=p>).</span><span class=nf>SetKeepAlivePeriod</span><span class=p>(</span><span class=mi>10</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span><span class=p>)</span>
<span class=ln>20</span>			<span class=k>return</span> <span class=nx>tls</span><span class=p>.</span><span class=nf>Client</span><span class=p>(</span><span class=nx>conn</span><span class=p>,</span> <span class=nx>tlsConfig</span><span class=p>),</span> <span class=kc>nil</span>
<span class=ln>21</span>		<span class=p>},</span>
<span class=ln>22</span>	<span class=p>}</span>
<span class=ln>23</span>
<span class=ln>24</span><span class=p>}</span>
<span class=ln>25</span>
<span class=ln>26</span><span class=kd>func</span> <span class=nf>init</span><span class=p>()</span> <span class=p>{</span>
<span class=ln>27</span>	<span class=nx>net</span><span class=p>.</span><span class=nx>DefaultResolver</span> <span class=p>=</span> <span class=nf>newResolver</span><span class=p>(</span><span class=err>&#39;</span><span class=nx>cloudflare</span><span class=o>-</span><span class=nx>dns</span><span class=p>.</span><span class=nx>com</span><span class=err>&#39;</span><span class=p>,</span> <span class=err>&#39;</span><span class=mf>1.0.0.1</span><span class=p>:</span><span class=mi>853</span><span class=err>&#39;</span><span class=p>)</span>
<span class=ln>28</span><span class=p>}</span></code></pre></div><h2 id=原理解析>原理解析</h2><p>Golang 在解析域名的时候会通过 <code>net.DefaultResolver</code> 来进行解析, 只需要写一个支持的 <code>net.Resolver</code> 就可以做到 DoT 了, 并且 Golang 自带了 tls 库可以方便的完成这一操作</p></div></article><ul class=pagination><li class="page-item page-prev"><a href=https://blog.indexyz.me/archives/recv-and-send-sms-in-raspberry-pi/><div class=page-item-subtitle>上一篇</div><div class="page-item-title h5">使用树莓派来收发短信</div></a></li><li class="page-item page-next"><a href=https://blog.indexyz.me/archives/upload-image-to-smms-when-use-trix-editor/><div class=page-item-subtitle>下一篇</div><div class="page-item-title h5">使用 Trix 编辑器的时候上传文件至 sm.ms</div></a></li></ul><div id=disqus_thread></div><script>new DisqusJS(JSON.parse("{\"api\":\"https://disqus.skk.moe/disqus/\",\"apikey\":\"VtpQwhbhO3YTIYSZdx1N8vOJ6me3une1xSIeXhpuPcE4jurE17UlJozkc9qhvjDw\",\"shortname\":\"indexyz-blog\",\"sitename\":\"Indexyz Blog\"}"))</script></section></div></main><footer class=page-footer><p>Copyright © 2018-2020, Indexyz</p><p>Power by
<a href=https://gohugo.io/>Hugo</a> | Theme
<a href=https://github.com/Indexyz/hugo-theme-index/>Index</a></p></footer></body></html>