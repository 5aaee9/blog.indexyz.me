<!doctype html><html lang=en><head><meta name=generator content="Hugo 0.57.2"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sharing light, even in death"><title>在 Spring Boot 中使用 Dubbo 以及 Kotlin 的坑 - Indexyz Blog</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/spectre.css@0.5.8/dist/spectre.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=https://blog.indexyz.me/css/syntax.css><link rel=stylesheet href=https://blog.indexyz.me/sass/main.min.bfe6bc4bb48fe5e39fc1dcbd6f38413f8c6c9bfcbb5541281b9be860cf0c3d8b.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/disqusjs@1.2/dist/disqusjs.css><script src=https://cdn.jsdelivr.net/npm/disqusjs@1.1/dist/disqus.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-97074604-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-97074604-1');</script></head><body><header id=page-header><div class="container grid-lg"><a href=https://blog.indexyz.me/ class=title>Indexyz Blog</a><h2 class=description>Sharing light, even in death</h2><div><nav id=nav-menu role=navigation><a href=/>首页</a>
<a href=/friends/>友链</a></nav></div></div></header><main><div class="container grid-lg"><section id=posts class=post-single><article temscope itemtype=http://schema.org/Article><header><h1 class=post-title itemprop="name headline"><a href=https://blog.indexyz.me/archives/dubbo-with-kotlin-in-spring-boot/ itemprop=url>在 Spring Boot 中使用 Dubbo 以及 Kotlin 的坑</a></h1><div class=post-meta-list><span class=post-meta><span>时间:</span>
<time datetime=2019-08-21T03:51:00&#43;0800>2019-08-21</time></span>
<span class=post-meta><span>分类:</span>
<a href=/categories/java itemprop=url rel=index><span itemprop=name>Java</span></a>
&nbsp;</span></span></div></header><div class=post-body itemprop=articleBody><p>最近写了点服务, 因为想尝试一下微服务的构架, 在项目中使用了 Dubbo 来做 RPC, 同时使用了 Kotlin 来简化语法(语法糖真甜)</p><h2 id=dubbo-序列化-kotlin-的-data-class-时需求-java-io-serializable>Dubbo 序列化 Kotlin 的 Data Class 时需求 <code>java.io.Serializable</code></h2><p>这个坑比较简单, 首先我安装了 <a href=https://github.com/Kotlin/kotlinx.serialization>kotlinx.serialization</a> 来序列化 kotlin 的 data class</p><p>将 Data Class 改成这样</p><div class=highlight><pre class=chroma><code class=language-kotlin data-lang=kotlin><span class=ln>1</span><span class=k>import</span> <span class=nn>kotlinx.serialization.Serializable</span>
<span class=ln>2</span><span class=k>import</span> <span class=nn>kotlinx.serialization.Polymorphic</span>
<span class=ln>3</span>
<span class=ln>4</span><span class=n>@Serializable</span>
<span class=ln>5</span><span class=k>data</span> <span class=k>class</span> <span class=nc>Testing</span> <span class=p>{</span>
<span class=ln>6</span>  <span class=k>val</span> <span class=py>value</span><span class=p>:</span> <span class=n>Map</span><span class=p>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>@Polymorphic</span> <span class=n>Any</span><span class=p>&gt;</span>
<span class=ln>7</span><span class=p>}</span> <span class=p>:</span> <span class=n>java</span><span class=p>.</span><span class=n>io</span><span class=p>.</span><span class=n>Serializable</span> <span class=p>{}</span></code></pre></div><p>这样 Dubbo 就可以序列化这个 Data Class 了</p><h2 id=dubbo-反序列化-data-class-回实例时报错>Dubbo 反序列化 Data Class 回实例时报错</h2><p>在默认情况下, Dubbo 使用修改过的 <code>hessian</code> 作为 <code>Serialization</code></p><p>但是在反序列化 Data Class 时会报错 <code>com.alibaba.com.caucho.hessian.io.HessianProtocolException: 'com.example.TestingClass' could not be instantiated</code></p><p>这个问题主要是由于 Data Class 没有无参数的构造器, 同时 Kotlin 在构造类时会对数据进行校验, 此时如果一个字段不能为 null 会丢错误出来. Hessian 会使用 <code>newInstance</code> 直接创建实例, 这时候校验就出错了.</p><p>解决方法也很简单, 将 <code>Serialization</code> 修改为不使用 <code>Hessian</code>, 此处修改成了 <code>fst</code></p><p>在依赖中添加 <code>org.apache.dubbo:dubbo-serialization-fst:2.7.3</code></p><p>然后在 <code>application.properties</code> 中添加 <code>dubbo.protocol.serialization=fst</code></p><p>此时 Dubbo 传 Data Class 就能正确的反实例化了</p><h2 id=传递懒加载的-data-class-时报错-class-not-found-classname>传递懒加载的 Data Class 时报错 <code>class not found CLASSNAME</code></h2><p>例如在 MongoDB 的 Object 中开启 <code>@DBRef(lazy = true)</code>, 会创建一个代理实例, 只有在用到的时候才加载</p><p>如果直接输出对应的 class 的话 会看到此时的类后有 <code>EnhancerByCGLIB</code> 的标志, 我们只需要在返回时复制一个对象返回, 例如 <code>return t.obj.copy()</code> 就会复制一个没有代理过的实例返回, 就解决了这个问题</p></div></article><ul class=pagination><li class="page-item page-prev"><a href=https://blog.indexyz.me/archives/2019-ustc-hackergame-writeup/><div class=page-item-subtitle>上一篇</div><div class="page-item-title h5">2019 USTC HackerGame Writeup</div></a></li><li class="page-item page-next"><a href=https://blog.indexyz.me/archives/startup-in-j1900/><div class=page-item-subtitle>下一篇</div><div class="page-item-title h5">在星际蜗牛主机上使用 LVM 安装 Arch Linux 以及常用软件</div></a></li></ul><div id=disqus_thread></div><script>new DisqusJS(JSON.parse("{\"api\":\"https://disqus.skk.moe/disqus/\",\"apikey\":\"VtpQwhbhO3YTIYSZdx1N8vOJ6me3une1xSIeXhpuPcE4jurE17UlJozkc9qhvjDw\",\"shortname\":\"indexyz-blog\",\"sitename\":\"Indexyz Blog\"}"))</script></section></div></main><footer class=page-footer><p>Copyright © 2018-2020, Indexyz</p><p>Power by
<a href=https://gohugo.io/>Hugo</a> | Theme
<a href=https://github.com/Indexyz/hugo-theme-index/>Index</a></p></footer></body></html>